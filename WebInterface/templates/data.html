{% extends "base.html" %}

{% block content %}
<div id="pingResponse" class="text-center">
    <p>Trying to connect...</p>
</div>

<h3 style="text-align:center; display: none;" id="sensorTitle">Sensor Data</h3>

<!-- id here has to match the back-end 'name', spaces are ignored -->
<div id="bodyLayout" style="display: none;">
    <h3>Old Sensors</h3>
    <div id="LeftFoot" class="sensor">Loading...</div>
    <div id="RightFoot" class="sensor">Loading...</div>
    <div id="LeftKnee" class="sensor">Loading...</div>
    <div id="RightKnee" class="sensor">Loading...</div>
    <div id="Waist" class="sensor">Loading...</div>
</div>

<div id="bodyLayout" style="display: none;"></div>
    <h3>Real Sensor</h3>
    <div id="RealSensor" class="sensor">Loading...</div>
</div>

<script>
    const TIMEOUT_DURATION = 5000; // Timeout duration for sensor data updates
    const sensorTimeouts = {}; // Keeps track of timeout for each sensor
    const sensorStatus = {
        LeftFoot: false,
        RightFoot: false,
        LeftKnee: false,
        RightKnee: false,
        Waist: false,
        RealSensor: false // Track real sensor status
    };

    const sensorFriendlyNames = {
        LeftFoot: "Left Foot",
        RightFoot: "Right Foot",
        LeftKnee: "Left Knee",
        RightKnee: "Right Knee",
        Waist: "Waist",
        RealSensor: "Real Sensor" // Friendly name for real sensor
    };

    function fetchData() {
        const raspberryPi_IP = "{{ request.cookies.get('raspberryPi_IP', default_raspberryPi_IP) }}";

        fetch(`${raspberryPi_IP}/ping`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error fetching ping data');
                }
                return response.json();
            })
            .then(pingData => {
                document.getElementById('pingResponse').innerHTML = `<p></p>`;
                document.getElementById('sensorTitle').style.display = 'block';
                document.getElementById('bodyLayout').style.display = 'block';

                setupSSE(raspberryPi_IP);  // Start receiving sensor data for old sensors
                setupRealSensorSSE(raspberryPi_IP);  // Start receiving real sensor data
            })
            .catch(error => {
                document.getElementById('pingResponse').innerHTML = `
                    <div class="text-center">
                        <h3>Couldn't connect</h3>
                        <p>Error fetching ping data: ${error.message}</p>
                    </div>`;

                document.getElementById('sensorTitle').style.display = 'none';
                document.getElementById('bodyLayout').style.display = 'none';
            });
    }

    function setupSSE(raspberryPi_IP) {
        const eventSource = new EventSource(`${raspberryPi_IP}/sensor-stream`);

        eventSource.onmessage = function(event) {
            const sensorData = JSON.parse(event.data);

            sensorData.forEach(sensor => {
                const sensorId = sensor.name.replace(/\s+/g, ""); // Removing spaces for ID
                const sensorElement = document.getElementById(sensorId);

                if (sensorTimeouts[sensorId]) {
                    clearTimeout(sensorTimeouts[sensorId]);
                }

                sensorStatus[sensorId] = true;

                if (sensorElement) {
                    sensorElement.innerHTML = `
                        <strong>${sensorFriendlyNames[sensorId]}</strong><br>
                        X: ${sensor.coordinates.x.toFixed(2)}<br>
                        Y: ${sensor.coordinates.y.toFixed(2)}<br>
                        Z: ${sensor.coordinates.z.toFixed(2)}<br>
                        Velocity: ${sensor.velocity.toFixed(2)} m/s<br>
                        Battery: ${sensor.battery_percentage.toFixed(1)}%
                    `;

                    sensorTimeouts[sensorId] = setTimeout(() => {
                        const friendlyName = sensorFriendlyNames[sensorId] || sensorId;
                        sensorElement.innerHTML = `
                            <br><br>
                            <strong>Couldn't connect to ${friendlyName}</strong><br>
                            <br><br>
                        `;
                        sensorStatus[sensorId] = false;
                    }, TIMEOUT_DURATION);
                }
            });

            // Check if any sensor is offline and update status
            for (const id in sensorStatus) {
                if (sensorStatus[id]) {
                    sensorStatus[id] = false;
                } else {
                    const sensorElement = document.getElementById(id);
                    if (sensorElement && sensorElement.innerHTML === "Loading...") {
                        sensorElement.innerHTML = `<br><br><strong>Couldn't connect to ${sensorFriendlyNames[id]}</strong><br><br><br>`;
                    }
                }
            }
        };

        eventSource.onerror = function() {
            document.getElementById('pingResponse').innerHTML = '<p>Error connecting to sensor stream.</p>';
        };
    }

    function setupRealSensorSSE(raspberryPi_IP) {
        const eventSource = new EventSource(`${raspberryPi_IP}/real-sensor-stream`);

        eventSource.onmessage = function(event) {
            const sensorData = JSON.parse(event.data);

            // Handle real sensor data
            const sensorId = 'RealSensor';
            const sensorElement = document.getElementById(sensorId);

            if (sensorTimeouts[sensorId]) {
                clearTimeout(sensorTimeouts[sensorId]);
            }

            sensorStatus[sensorId] = true;

            if (sensorElement) {
                sensorElement.innerHTML = `
                    <strong>${sensorFriendlyNames[sensorId]}</strong><br>
                    X: ${sensorData.position.x.toFixed(2)}<br>
                    Y: ${sensorData.position.y.toFixed(2)}<br>
                    Z: ${sensorData.position.z.toFixed(2)}<br>
                    Velocity: ${sensorData.velocity.toFixed(2)} m/s<br>
                    Pitch: ${sensorData.orientation.pitch.toFixed(2)}Â°
                `;



                // Timeout after 5 seconds if no new data received
                sensorTimeouts[sensorId] = setTimeout(() => {
                    const friendlyName = sensorFriendlyNames[sensorId] || sensorId;
                    sensorElement.innerHTML = `
                        <br><br>
                        <strong>Couldn't connect to ${friendlyName}</strong><br>
                        <br><br>
                    `;
                    sensorStatus[sensorId] = false;
                }, TIMEOUT_DURATION);
            }
        };

        eventSource.onerror = function() {
            document.getElementById('pingResponse').innerHTML = '<p>Error connecting to real sensor stream.</p>';
        };
    }

    document.addEventListener('DOMContentLoaded', fetchData);
</script>

{% endblock %}
